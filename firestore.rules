rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user ID
    function getUserId() {
      return request.auth.uid;
    }

    // Helper function to check if user is part of a link pair
    function isLinkedUser(linkDoc) {
      let uid = getUserId();
      return linkDoc.data.a == uid || linkDoc.data.b == uid;
    }

    // Links collection: shared documents between two users
    match /links/{linkId} {
      // Read: user must be part of the link
      allow read: if isAuthenticated() && 
        (resource.data.a == getUserId() || resource.data.b == getUserId());
      
      // Create/Update: user must be part of the link pair with comprehensive validation
      allow create: if isAuthenticated() && 
        request.resource.data.keys().hasAll(['a', 'b', 'linked', 'updatedAt']) &&
        request.resource.data.a is string &&
        request.resource.data.b is string &&
        request.resource.data.a.size() > 0 &&
        request.resource.data.b.size() > 0 &&
        request.resource.data.a != request.resource.data.b &&
        request.resource.data.linked is bool &&
        request.resource.data.updatedAt is int &&
        request.resource.data.updatedAt > 0 &&
        request.resource.data.size() <= 10 && // Limit document size
        (request.resource.data.a == getUserId() || request.resource.data.b == getUserId());
      
      allow update: if isAuthenticated() && 
        isLinkedUser(resource) &&
        request.resource.data.keys().hasAll(['a', 'b', 'linked', 'updatedAt']) &&
        request.resource.data.a is string &&
        request.resource.data.b is string &&
        request.resource.data.a == resource.data.a && // Cannot change user IDs
        request.resource.data.b == resource.data.b &&
        request.resource.data.updatedAt is int &&
        request.resource.data.updatedAt > resource.data.updatedAt &&
        request.resource.data.size() <= 10; // Limit document size

      // Subcollections under links
      match /game/{gameId} {
        allow read, write: if isAuthenticated() && isLinkedUser(get(/databases/$(database)/documents/links/$(linkId)));
      }

      match /stats/{statsId} {
        allow read, write: if isAuthenticated() && isLinkedUser(get(/databases/$(database)/documents/links/$(linkId)));
      }

      match /plans/{planId} {
        allow read, write: if isAuthenticated() && isLinkedUser(get(/databases/$(database)/documents/links/$(linkId)));
      }

      match /rtc/{signalId} {
        allow read, write: if isAuthenticated() && isLinkedUser(get(/databases/$(database)/documents/links/$(linkId)));
      }

      match /rtc_candidates/{candidateId} {
        allow read, write: if isAuthenticated() && isLinkedUser(get(/databases/$(database)/documents/links/$(linkId)));
      }
    }

    // Lists collection: user's personal lists
    match /lists/{userId} {
      allow read: if isAuthenticated() && getUserId() == userId;
      allow write: if isAuthenticated() && getUserId() == userId;
      
      match /items/{itemId} {
        allow read: if isAuthenticated() && getUserId() == userId;
        allow create: if isAuthenticated() && getUserId() == userId &&
          request.resource.data.keys().hasAll(['poseId', 'lists', 'updatedAt']) &&
          request.resource.data.poseId is int &&
          request.resource.data.poseId > 0 &&
          request.resource.data.lists is list &&
          request.resource.data.updatedAt is int &&
          request.resource.data.updatedAt > 0 &&
          request.resource.data.size() <= 5; // Limit item size
        allow update: if isAuthenticated() && getUserId() == userId &&
          request.resource.data.keys().hasAll(['poseId', 'lists', 'updatedAt']) &&
          request.resource.data.poseId == resource.data.poseId && // Cannot change poseId
          request.resource.data.updatedAt is int &&
          request.resource.data.updatedAt > resource.data.updatedAt &&
          request.resource.data.size() <= 5;
        allow delete: if isAuthenticated() && getUserId() == userId;
      }
    }

    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
